<!DOCTYPE html>
<html lang="zh">
<head>

  <meta charset="UTF-8">
  <title>温湿度监控</title>
  <style>
    /* 布局区域 */
    body {
      margin: 0;
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 100vh;
      font-family: sans-serif;
    }

    @media (max-width: 700px) {
      body {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      #sidebar {
        flex-direction: row;
        justify-content: center;
        border-right: none;
        border-bottom: 1px solid #ccc;
      }
    }

    /* 侧边栏 */
#sidebar.collapsed {
  width: 60px;
  align-items: center;
}
#sidebar.collapsed button span {
  display: none;
}
#sidebar.collapsed button::before {
  font-size: 18px;
  display: inline-block;
  content: attr(data-icon);
}

    #sidebar {
      background-color: #f5f5f5;
      border-right: 1px solid #ccc;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #sidebar button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #ddd;
      border-radius: 4px;
    }

    #sidebar button:hover {
      background-color: #ccc;
    }

    /* 主内容 */
    #main {
      padding: 20px;
      overflow-y: auto;
    }

    /* 传感器容器 */
    #sensors-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      container-type: inline-size;
    }

    .sensor-group {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      background: white;
      width: 100%;
      max-width: 260px;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sensor-title {
      font-weight: bold;
      font-size: 1.1em;
    }

    .sensor-value {
      font-size: 1.3em;
    }

    @container (max-width: 200px) {
      .sensor-value {
        font-size: 1em;
      }
    }

    /* 表格样式 */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #eee;
    }

    /* 阈值设置区 */
    #threshold label {
      display: block;
      margin-top: 10px;
    }

    #threshold input {
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    #threshold button {
      margin-top: 15px;
      padding: 8px 15px;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- 左边菜单 -->
  <div id="sidebar">
<button onclick="toggleSidebar()" data-icon="⏪"><span>折叠菜单</span></button>
<button onclick="showPage('monitor')" data-icon="📊"><span>实时数据</span></button>
<button onclick="showPage('threshold')" data-icon="⚙️"><span>阈值设置</span></button>
  </div>

  <!-- 右边主内容 -->
  <div id="main">
    <div id="monitor" style="display: block;">
      <h2>实时温湿度</h2>
      <div id="sensors-container"></div>
      <table id="tbl">
        <thead>
          <tr><th>设备 ID</th><th>温度 </th><th>湿度 </th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>





    <div id="threshold" style="display: none;">
      <h2>告警阈值设置</h2>
           <label>浇水阈值 :  <input id="hum_high"  type="number" step="1"></label>
      <label>关水阈值 :  <input id="hum_low"   type="number" step="1"></label>
      <button onclick="load()">读取当前配置</button>
      <button onclick="save()">保存</button>
      <div id="status"></div>
    </div>
  </div>

  <script>
async function pumpControl(id, action) {
  const statusEl = document.getElementById(`pump-status-${id}`);
  statusEl.textContent = '正在发送指令...';

  const url = `http://127.0.0.1:8999/pump/${action}/${id}`;
  try {
    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
      statusEl.textContent = action === 'on'
        ? `水泵(ID:${id}) 已开启`
        : `水泵(ID:${id}) 已关闭`;
    } else {
      statusEl.textContent = '操作失败';
    }
  } catch (e) {
    console.error('控制水泵失败:', e);
    statusEl.textContent = '请求错误';
  }
}



function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("collapsed");
}
    function showPage(id) {
      document.getElementById("monitor").style.display = id === "monitor" ? "block" : "none";
      document.getElementById("threshold").style.display = id === "threshold" ? "block" : "none";
    }

    async function refresh() {
      try {
        const res = await fetch("http://127.0.0.1:8999/latest");
        const list = await res.json(); // [{id, temperature, humidity}]

        const container = document.getElementById("sensors-container");
        const tbody = document.querySelector("#tbl tbody");

        container.innerHTML = "";
        tbody.innerHTML = "";

        for (const d of list) {
          const card = document.createElement("div");
          card.className = "sensor-group";


card.innerHTML = `
  <div class="sensor-title">设备 ID: ${d.id}</div>
  <div>💧 湿度: <span class="sensor-value">${parseFloat(d.humidity).toFixed(1)}</span></div>
  <div style="margin-top:10px;">
    <button onclick="pumpControl('${d.id}', 'on')">开启水泵</button>
    <button onclick="pumpControl('${d.id}', 'off')">关闭水泵</button>
  </div>
  <div id="pump-status-${d.id}" style="margin-top:5px; font-weight:bold; color:#333;"></div>
`;

          container.appendChild(card);

          tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${d.id}</td>
              <td>${parseFloat(d.temperature).toFixed(1)}</td>
              <td>${parseFloat(d.humidity).toFixed(1)}</td>
            </tr>
          `);
        }
      } catch (e) {
        console.error("无法获取传感器数据", e);
      }
    }

    async function load() {
      document.getElementById('status').textContent = '正在加载...';
      try {
        const res = await fetch('http://127.0.0.1:8999/alarm/threshold/get');
        const data = await res.json();
             document.getElementById('hum_high').value  = data.hum_high;
        document.getElementById('hum_low').value   = data.hum_low;
        document.getElementById('status').textContent = '加载成功';
      } catch (e) {
        document.getElementById('status').textContent = '加载失败';
      }
    }

    async function save() {
      const payload = {
        temp_high: 0,
        temp_low:  0,
        hum_high:  parseInt(document.getElementById('hum_high').value),
        hum_low:   parseInt(document.getElementById('hum_low').value)
      };

      try {
        const res = await fetch('http://127.0.0.1:8999/alarm/threshold', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        document.getElementById('status').textContent = res.ok ? '保存成功' : '保存失败';
      } catch (e) {
        document.getElementById('status').textContent = '请求错误';
      }
    }

    refresh();
    setInterval(refresh, 3000);
  </script>
</body>
</html>
