<!DOCTYPE html>
<html lang="zh">
<head>

  <meta charset="UTF-8">
  <title>æ¸©æ¹¿åº¦ç›‘æ§</title>
  <style>
    /* å¸ƒå±€åŒºåŸŸ */
    body {
      margin: 0;
      display: grid;
      grid-template-columns: 220px 1fr;
      height: 100vh;
      font-family: sans-serif;
    }

    @media (max-width: 700px) {
      body {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
      }
      #sidebar {
        flex-direction: row;
        justify-content: center;
        border-right: none;
        border-bottom: 1px solid #ccc;
      }
    }

    /* ä¾§è¾¹æ  */
#sidebar.collapsed {
  width: 60px;
  align-items: center;
}
#sidebar.collapsed button span {
  display: none;
}
#sidebar.collapsed button::before {
  font-size: 18px;
  display: inline-block;
  content: attr(data-icon);
}

    #sidebar {
      background-color: #f5f5f5;
      border-right: 1px solid #ccc;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #sidebar button {
      padding: 10px;
      font-size: 16px;
      cursor: pointer;
      border: none;
      background-color: #ddd;
      border-radius: 4px;
    }

    #sidebar button:hover {
      background-color: #ccc;
    }

    /* ä¸»å†…å®¹ */
    #main {
      padding: 20px;
      overflow-y: auto;
    }

    /* ä¼ æ„Ÿå™¨å®¹å™¨ */
    #sensors-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      container-type: inline-size;
    }

    .sensor-group {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      background: white;
      width: 100%;
      max-width: 260px;
      flex: 1 1 auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .sensor-title {
      font-weight: bold;
      font-size: 1.1em;
    }

    .sensor-value {
      font-size: 1.3em;
    }

    @container (max-width: 200px) {
      .sensor-value {
        font-size: 1em;
      }
    }

    /* è¡¨æ ¼æ ·å¼ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #eee;
    }

    /* é˜ˆå€¼è®¾ç½®åŒº */
    #threshold label {
      display: block;
      margin-top: 10px;
    }

    #threshold input {
      padding: 6px;
      width: 100%;
      box-sizing: border-box;
    }

    #threshold button {
      margin-top: 15px;
      padding: 8px 15px;
    }

    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <!-- å·¦è¾¹èœå• -->
  <div id="sidebar">
<button onclick="toggleSidebar()" data-icon="âª"><span>æŠ˜å èœå•</span></button>
<button onclick="showPage('monitor')" data-icon="ğŸ“Š"><span>å®æ—¶æ•°æ®</span></button>
<button onclick="showPage('threshold')" data-icon="âš™ï¸"><span>é˜ˆå€¼è®¾ç½®</span></button>
  </div>

  <!-- å³è¾¹ä¸»å†…å®¹ -->
  <div id="main">
    <div id="monitor" style="display: block;">
      <h2>å®æ—¶æ¸©æ¹¿åº¦</h2>
      <div id="sensors-container"></div>
      <table id="tbl">
        <thead>
          <tr><th>è®¾å¤‡ ID</th><th>æ¸©åº¦ </th><th>æ¹¿åº¦ </th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>





    <div id="threshold" style="display: none;">
      <h2>å‘Šè­¦é˜ˆå€¼è®¾ç½®</h2>
           <label>æµ‡æ°´é˜ˆå€¼ :  <input id="hum_high"  type="number" step="1"></label>
      <label>å…³æ°´é˜ˆå€¼ :  <input id="hum_low"   type="number" step="1"></label>
      <button onclick="load()">è¯»å–å½“å‰é…ç½®</button>
      <button onclick="save()">ä¿å­˜</button>
      <div id="status"></div>
    </div>
  </div>

  <script>
async function pumpControl(id, action) {
  const statusEl = document.getElementById(`pump-status-${id}`);
  statusEl.textContent = 'æ­£åœ¨å‘é€æŒ‡ä»¤...';

  const url = `http://127.0.0.1:8999/pump/${action}/${id}`;
  try {
    const res = await fetch(url, { method: 'POST' });
    if (res.ok) {
      statusEl.textContent = action === 'on'
        ? `æ°´æ³µ(ID:${id}) å·²å¼€å¯`
        : `æ°´æ³µ(ID:${id}) å·²å…³é—­`;
    } else {
      statusEl.textContent = 'æ“ä½œå¤±è´¥';
    }
  } catch (e) {
    console.error('æ§åˆ¶æ°´æ³µå¤±è´¥:', e);
    statusEl.textContent = 'è¯·æ±‚é”™è¯¯';
  }
}



function toggleSidebar() {
  document.getElementById("sidebar").classList.toggle("collapsed");
}
    function showPage(id) {
      document.getElementById("monitor").style.display = id === "monitor" ? "block" : "none";
      document.getElementById("threshold").style.display = id === "threshold" ? "block" : "none";
    }

    async function refresh() {
      try {
        const res = await fetch("http://127.0.0.1:8999/latest");
        const list = await res.json(); // [{id, temperature, humidity}]

        const container = document.getElementById("sensors-container");
        const tbody = document.querySelector("#tbl tbody");

        container.innerHTML = "";
        tbody.innerHTML = "";

        for (const d of list) {
          const card = document.createElement("div");
          card.className = "sensor-group";


card.innerHTML = `
  <div class="sensor-title">è®¾å¤‡ ID: ${d.id}</div>
  <div>ğŸ’§ æ¹¿åº¦: <span class="sensor-value">${parseFloat(d.humidity).toFixed(1)}</span></div>
  <div style="margin-top:10px;">
    <button onclick="pumpControl('${d.id}', 'on')">å¼€å¯æ°´æ³µ</button>
    <button onclick="pumpControl('${d.id}', 'off')">å…³é—­æ°´æ³µ</button>
  </div>
  <div id="pump-status-${d.id}" style="margin-top:5px; font-weight:bold; color:#333;"></div>
`;

          container.appendChild(card);

          tbody.insertAdjacentHTML("beforeend", `
            <tr>
              <td>${d.id}</td>
              <td>${parseFloat(d.temperature).toFixed(1)}</td>
              <td>${parseFloat(d.humidity).toFixed(1)}</td>
            </tr>
          `);
        }
      } catch (e) {
        console.error("æ— æ³•è·å–ä¼ æ„Ÿå™¨æ•°æ®", e);
      }
    }

    async function load() {
      document.getElementById('status').textContent = 'æ­£åœ¨åŠ è½½...';
      try {
        const res = await fetch('http://127.0.0.1:8999/alarm/threshold/get');
        const data = await res.json();
             document.getElementById('hum_high').value  = data.hum_high;
        document.getElementById('hum_low').value   = data.hum_low;
        document.getElementById('status').textContent = 'åŠ è½½æˆåŠŸ';
      } catch (e) {
        document.getElementById('status').textContent = 'åŠ è½½å¤±è´¥';
      }
    }

    async function save() {
      const payload = {
        temp_high: 0,
        temp_low:  0,
        hum_high:  parseInt(document.getElementById('hum_high').value),
        hum_low:   parseInt(document.getElementById('hum_low').value)
      };

      try {
        const res = await fetch('http://127.0.0.1:8999/alarm/threshold', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        document.getElementById('status').textContent = res.ok ? 'ä¿å­˜æˆåŠŸ' : 'ä¿å­˜å¤±è´¥';
      } catch (e) {
        document.getElementById('status').textContent = 'è¯·æ±‚é”™è¯¯';
      }
    }

    refresh();
    setInterval(refresh, 3000);
  </script>
</body>
</html>
